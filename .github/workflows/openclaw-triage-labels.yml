name: openclaw-triage-labels

on:
  schedule:
    # every 6 hours at minute 10
    - cron: "10 */6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TRIAGE_LABELING_ENABLED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        if: env.TRIAGE_LABELING_ENABLED == '1'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        if: env.TRIAGE_LABELING_ENABLED == '1'
        run: pip install --disable-pip-version-check requests

      - name: Token diagnostics
        if: env.TRIAGE_LABELING_ENABLED == '1'
        env:
          TRIAGE_GH_TOKEN: ${{ secrets.TRIAGE_GH_TOKEN }}
        run: |
          if [ -n "$TRIAGE_GH_TOKEN" ]; then
            echo "TRIAGE_GH_TOKEN is configured"
          else
            echo "::warning::TRIAGE_GH_TOKEN is empty or unavailable in this workflow run"
          fi

      - name: Triage labeling suspended
        if: env.TRIAGE_LABELING_ENABLED != '1'
        run: |
          echo "::notice::triage-labeling is temporarily suspended due to cross-repo permission failures"
          echo "::notice::Set TRIAGE_LABELING_ENABLED=1 in the workflow to re-enable"

      - name: Triage labels across openclaw-* repos (labeling-only)
        if: env.TRIAGE_LABELING_ENABLED == '1'
        env:
          # GITHUB_TOKEN: works for openclaw-ops repo only (where this workflow runs)
          # TRIAGE_GH_TOKEN: required for cross-repo access (create PAT with repo scope)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIAGE_GH_TOKEN: ${{ secrets.TRIAGE_GH_TOKEN }}
          GH_OWNER: homeofe
          REPO_PREFIX: openclaw-
          PER_REPO_LIMIT: "30"
          SKIP_ARCHIVED: "1"
          SKIP_FORKS: "1"
        run: python scripts/triage_labels.py
